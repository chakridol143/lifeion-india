<!-- =======================
   TOP INFO BAR
======================= -->
<div class="top-bar">
  Give Your Family the Gift of  Healthy Water. Call
  <strong>844-335-2174</strong>
</div>

<!-- =======================
   MAIN HEADER
======================= -->
<div class="header-main">
  <div class="header-logo" [class.home-logo]="isHomePage">
    <img src="/images/Ionizer_Logo.png" alt="Life Ionizers" />
  </div>

  <div class="header-search desktop-only">
    <div class="search-category">
      All <i class="bx bx-chevron-down"></i>
    </div>
    <input type="text" placeholder="Search for products" />
    <i class="bx bx-microphone"></i>
  </div>

  <div class="header-actions">
    <div class="icon-circle mobile-search-icon" (click)="openSearch()">
      <i class="bx bx-search"></i>
    </div>
    <!-- <div class="icon-circle"><i class="bx bx-user"></i></div> -->

    <!-- LOGIN ICON -->
<ng-container *ngIf="!user">
  <div class="icon-circle" (click)="goToLogin()">
    <i class="bx bx-user"></i>
  </div>
</ng-container>

<!-- LOGOUT -->
<ng-container *ngIf="user">
  <div class="icon-circle logout" (click)="logoutUser()">
    <i class="bx bx-log-out"></i>
  </div>
</ng-container>

    <!-- <div class="icon-circle cart"><i class="bx bx-cart"></i></div> -->
 <div class="icon-circle cart" (click)="toggleCartDetails()"><i class="bx bx-cart"></i>
    
      <span class="cart-count" *ngIf="cartCount > 0">{{ cartCount }}</span>
    </div>

    <app-cart-details
      *ngIf="showCartPopup"
      [items]="items"
      (close)="closeDetails()"
      (remove)="cartItemRemove($event)"
      (clear)="handleClear()">
    </app-cart-details>

    <div class="icon-circle mobile-menu-icon" (click)="toggleMenu()">
      <i class="bx bx-menu" *ngIf="!menuOpen"></i>
      <i class="bx bx-x" *ngIf="menuOpen"></i>
    </div>
  </div>
</div>

<!-- =======================
   SEARCH OVERLAY
======================= -->
<div class="full-search" [class.active]="searchOpen">
  <div class="search-area">
    <i class="bx bx-search search-big-icon"></i>
    <input
      type="text"
      [(ngModel)]="overlaySearch"
      placeholder="SEARCH FOR..."
      (keydown.enter)="performSearch()"
      class="search-input"
    />
    <span class="close-search" (click)="closeSearch()">✕</span>
  </div>
</div>

<!-- ================= IONIZER FILTERS ================= -->
<nav class="header-nav desktop-only">

  
  <!-- ================= OTHER NAV ITEMS ================= -->
  <ng-container *ngFor="let item of navItems">

    <!-- Skip Water Systems here -->
    <ng-container *ngIf="item.label !== 'Water Systems'">

      <!-- DROPDOWNS -->
      <div *ngIf="hasSubmenu(item)" class="nav-link nav-dropdown">
        <a
          [routerLink]="item.route || null"
          (click)="navigateAndClose(item.route)"
        >
          {{ item.label }} <i class="bx bx-chevron-down"></i>
        </a>

        <div class="dropdown-wrapper">
          <ul class="dropdown-menu">
            <li *ngFor="let sub of item.submenu">
              <a [routerLink]="sub.route" (click)="navigateAndClose(sub.route)">{{ sub.label }}</a>
            </li>
          </ul>
        </div>
      </div>

      <!-- NORMAL LINKS -->
      <a
        *ngIf="!hasSubmenu(item)"
        [routerLink]="item.route"
        class="nav-link" >
        {{ item.label }}
      </a>

    </ng-container>
  </ng-container>

<div
  class="nav-dropdown-wrapper"
  (mouseenter)="onIonizerHover()"
  (mouseleave)="onIonizerLeave()"
>
  <a class="nav-link no-route">
    Ionizer Filters <i class="bx bx-chevron-down"></i>
  </a>

  <div class="mega-menu ionizer-layout" *ngIf="showIonizerMenu">
    <div
      class="ionizer-column"
      *ngFor="let cat of ionizerCategories"
    >
      <!-- CATEGORY TITLE -->
      <div class="ionizer-title">
        <img
          *ngIf="cat.image_url"
          [src]="resolveImageUrl(cat.image_url)"
        />
        <a
          [routerLink]="getIonizerCollectionSlug(cat.name) === 'reverse-osmosis' ? ['/reverse-osmosis'] : ['/product-details']"
          [queryParams]="getIonizerCollectionSlug(cat.name) === 'reverse-osmosis' ? null : { collection: getIonizerCollectionSlug(cat.name) }"
          (click)="closeIonizerMenu()"
        >
          {{ cat.name }}
        </a>
      </div>

      <!-- PRODUCTS -->
      <ul class="ionizer-products">
        <li
          *ngFor="let p of ionizerProductsMap[cat.category_id]"
          (click)="goToProduct(p)"
        >
          {{ p.name }}
        </li>

        <li
          *ngIf="!ionizerProductsMap[cat.category_id]?.length"
          class="empty-products"
        >
          No products
        </li>
      </ul>
    </div>
  </div>
</div>


  <!-- ================= WATER SYSTEMS ONLY ================= -->
<div
  class="nav-dropdown-wrapper"
  (mouseenter)="onDropdownHover()"
  (mouseleave)="onDropdownLeave()"
>
  <a
    class="nav-link no-route"
    [routerLink]="'/water-systems'"
    (click)="navigateAndClose('/water-systems')"
  >
    Water Systems <i class="bx bx-chevron-down"></i>
  </a>

  <!-- MEGA MENU -->
  <div class="mega-menu water-systems-menu" *ngIf="showMegaMenu">

    <!-- LEFT: CATEGORIES -->
    <div class="mega-left">
      <div
        class="mega-category"
        *ngFor="let cat of categories"
        (mouseenter)="onCategoryHover(cat.category_id)"
        [class.active]="activeCategoryId === cat.category_id"
      >
        <div class="category-left">
          <img
            *ngIf="cat.image_url"
            [src]="resolveImageUrl(cat.image_url)"
          />
          <span>{{ cat.name }}</span>
        </div>
        <span class="arrow">›</span>
      </div>
    </div>

    <!-- RIGHT: PRODUCTS -->
    <div class="mega-right">
      <div
        class="mega-product"
        *ngFor="let p of products"
        (click)="goToProduct(p)"
      >
        <img
          *ngIf="p.image_url"
          [src]="resolveImageUrl(p.image_url)"
        />
        <p>{{ p.name }}</p>
      </div>

      <div
        class="empty-products"
        *ngIf="products.length === 0"
      >
        No products available
      </div>
    </div>

  </div>
</div>



</nav>


<!-- =======================
   MOBILE MENU OVERLAY
======================= -->
<div
  class="mobile-menu-overlay"
  [class.active]="menuOpen"
  (click)="closeMenu()"
></div>

<!-- =======================
   MOBILE MENU PANEL
======================= -->
<div
  class="mobile-menu-panel"
  [class.active]="menuOpen"
  #mobilePanel
  tabindex="-1"
>
  <div class="mobile-menu-header">
    <ng-container [ngSwitch]="mobileScreen">
      <div *ngSwitchCase="'water'" class="panel-title-row">
        <span class="panel-title">Menu</span>
        <button class="icon-btn close-btn" (click)="closeMenu()" aria-label="Close menu">&#10005;</button>
      </div>
      <div *ngSwitchDefault class="panel-title-row">
        <span class="panel-title">Menu</span>
        <button class="icon-btn close-btn" (click)="closeMenu()" aria-label="Close menu">&#10005;</button>
      </div>
    </ng-container>
  </div>

  <!-- Root screen -->
  <div class="mobile-screen" [class.active]="mobileScreen === 'root'">
    <div class="mobile-row">
      <button class="mobile-item" (click)="navigateAndClose('/')">
        <span>Home</span>
        <i class="bx bx-chevron-right"></i>
      </button>
    </div>
    <div class="divider"></div>

    <div class="mobile-row">
      <button class="mobile-item has-children" (click)="openWaterScreen()">
        <span>Water Systems</span>
        <i class="bx bx-chevron-right"></i>
      </button>
    </div>
    <div class="divider"></div>

    <div class="mobile-row">
      <button class="mobile-item has-children" (click)="openIonizerScreen()">
        <span>Ionizer Filters</span>
        <i class="bx bx-chevron-right"></i>
      </button>
    </div>
    <div class="divider"></div>

    <div class="mobile-row">
      <button class="mobile-item" (click)="navigateAndClose('/comparison')">
        <span>Comparison</span>
        <i class="bx bx-chevron-right"></i>
      </button>
    </div>
    <div class="divider"></div>

    <div class="mobile-row">
      <button class="mobile-item has-children" (click)="openSimpleScreen('learn')">
        <span>Learn</span>
        <i class="bx bx-chevron-right"></i>
      </button>
    </div>
    <div class="divider"></div>

    <div class="mobile-row">
      <button class="mobile-item has-children" (click)="openSimpleScreen('testimonials')">
        <span>Testimonials</span>
        <i class="bx bx-chevron-right"></i>
      </button>
    </div>
    <div class="divider"></div>

    <button class="mobile-item" (click)="navigateAndClose('/finance')">Finance</button>

    <div class="mobile-row">
      <button class="mobile-item has-children" (click)="openSimpleScreen('support')">
        <span>Support</span>
        <i class="bx bx-chevron-right"></i>
      </button>
    </div>
    <div class="divider"></div>

    <div class="mobile-row">
      <button class="mobile-item" (click)="navigateAndClose('/contact')">
        <span>About Us</span>
        <i class="bx bx-chevron-right"></i>
      </button>
    </div>
    <div class="divider"></div>

    <div class="mobile-row">
      <button class="mobile-item" (click)="navigateAndClose('/contact')">
        <span>Contact</span>
        <i class="bx bx-chevron-right"></i>
      </button>
    </div>
    <div class="divider"></div>
  </div>

  <!-- Water Systems screen -->
  <div class="mobile-screen" [class.active]="mobileScreen === 'water'">
    <div class="section-heading">
      <button class="icon-btn back-btn" (click)="backToRoot()" aria-label="Back">&#8249;</button>
      <span>Water Systems</span>
    </div>
    <div class="accordion">
      <div
        class="accordion-item"
        *ngFor="let cat of waterSystemCategories"
      >
        <button
          class="accordion-toggle"
          (click)="toggleWaterCategory(cat)"
          [attr.aria-expanded]="expandedWaterCategoryId === cat.category_id"
        >
          <span class="toggle-left">
            <img *ngIf="cat.image_url" class="item-icon" [src]="resolveImageUrl(cat.image_url)" alt="" />
            {{ cat.name }}
          </span>
          <i class="bx" [ngClass]="expandedWaterCategoryId === cat.category_id ? 'bx-chevron-up' : 'bx-chevron-down'"></i>
        </button>
        <div class="accordion-body" [class.open]="expandedWaterCategoryId === cat.category_id">
          <div class="product-grid">
            <button
              class="product-card"
              *ngFor="let p of waterProductsMap[cat.category_id]"
              (click)="goToProduct(p); closeMenu()"
            >
              <img [src]="resolveImageUrl(p.image_url)" alt="" />
              <span>{{ p.name }}</span>
            </button>
          </div>
          <div class="accordion-empty" *ngIf="(waterProductsMap[cat.category_id]?.length || 0) === 0">
            No products
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- Ionizer Filters screen -->
  <div class="mobile-screen" [class.active]="mobileScreen === 'ionizer'">
    <div class="section-heading">
      <button class="icon-btn back-btn" (click)="backToRoot()" aria-label="Back">&#8249;</button>
      <span>Ionizer Filters</span>
    </div>
    <div class="accordion">
      <div
        class="accordion-item"
        *ngFor="let cat of ionizerCategories"
      >
        <button
          class="accordion-toggle"
          (click)="toggleIonizerCategory(cat)"
          [attr.aria-expanded]="expandedIonizerCategoryId === cat.category_id"
        >
          <span class="toggle-left">
            <img *ngIf="cat.image_url" class="item-icon" [src]="resolveImageUrl(cat.image_url)" alt="" />
            {{ cat.name }}
          </span>
          <i class="bx" [ngClass]="expandedIonizerCategoryId === cat.category_id ? 'bx-chevron-up' : 'bx-chevron-down'"></i>
        </button>
        <div class="accordion-body" [class.open]="expandedIonizerCategoryId === cat.category_id">
          <div class="product-grid">
            <button
              class="product-card"
              *ngFor="let p of ionizerProductsMap[cat.category_id]"
              (click)="goToProduct(p); closeMenu()"
            >
              <img [src]="resolveImageUrl(p.image_url)" alt="" />
              <span>{{ p.name }}</span>
            </button>
          </div>
          <div class="accordion-empty" *ngIf="(ionizerProductsMap[cat.category_id]?.length || 0) === 0">
            No products
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- Simple screens: Learn / Testimonials / Support -->
  <div class="mobile-screen" [class.active]="mobileScreen === 'learn'">
    <div class="section-heading">
      <button class="icon-btn back-btn" (click)="backToRoot()" aria-label="Back">&#8249;</button>
      <span>Learn</span>
    </div>
    <div class="mobile-group">
      <button class="mobile-subitem" *ngFor="let sub of learnItems" (click)="navigateAndClose(sub.route)">
        {{ sub.label }}
      </button>
    </div>
  </div>

  <div class="mobile-screen" [class.active]="mobileScreen === 'testimonials'">
    <div class="section-heading">
      <button class="icon-btn back-btn" (click)="backToRoot()" aria-label="Back">&#8249;</button>
      <span>Testimonials</span>
    </div>
    <div class="mobile-group">
      <button class="mobile-subitem" *ngFor="let sub of testimonialsItems" (click)="navigateAndClose(sub.route)">
        {{ sub.label }}
      </button>
    </div>
  </div>

  <div class="mobile-screen" [class.active]="mobileScreen === 'support'">
    <div class="section-heading">
      <button class="icon-btn back-btn" (click)="backToRoot()" aria-label="Back">&#8249;</button>
      <span>Support</span>
    </div>
    <div class="mobile-group">
      <button class="mobile-subitem" *ngFor="let sub of supportItems" (click)="navigateAndClose(sub.route)">
        {{ sub.label }}
      </button>
    </div>
  </div>
</div>
